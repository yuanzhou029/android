name: "Download Translations"
description: "Reaches out to Lokalise to download the latest translations."
inputs:
  lokalise-project:
    description: "The project id in lokalise"
    required: true
  lokalise-token:
    description: "An API token that has read access to the desired project"
    required: true
runs:
  using: "composite"
  steps:
    - name: Get Translations
      id: translations
      shell: bash
      run: |
        # 捕获整个 Lokalise API 响应，而不是直接管道给 jq
        LOKALISE_API_RESPONSE=$(curl --location --request POST "https://api.lokalise.com/api2/projects/${{inputs.lokalise-project}}/files/download" \
            --header "X-Api-Token: ${{inputs.lokalise-token}}" \
            --header 'Content-Type: application/json' \
            --data-raw '{
                "format": "xml",
                "original_filenames": false,
                "bundle_structure": "common/src/main/res/values-%LANG_ISO%/strings.%FORMAT%",
                "add_newline_eof": true,
                "replace_breaks": true,
                "export_empty_as": "skip"
            }')

        # 打印完整的 API 响应，以便调试
        echo "Lokalise API Full Response:"
        echo "$LOKALISE_API_RESPONSE"

        # 从响应中提取 bundle_url
        ZIP=$(echo "$LOKALISE_API_RESPONSE" | jq -r '.bundle_url')

        echo "Download Ready: $ZIP"

        # 添加检查，如果 ZIP 为空或 "null"，则报错
        if [ "$ZIP" = "null" ] || [ -z "$ZIP" ]; then
            echo "Error: Lokalise API did not return a valid bundle_url. Please check your Lokalise project ID, API token, permissions, and ensure there are translatable files configured correctly."
            exit 1
        fi

        curl "$ZIP" --output strings.zip # 最佳实践，用引号包围变量

        echo "Download Complete, unzipping"
        unzip -n strings.zip
        echo "Unzipped strings, generating locales_config.xml"

        XML_START='<?xml version="1.0" encoding="utf-8"?>\n<locale-config xmlns:android="http://schemas.android.com/apk/res/android">\n'
        XML_LOCALES=''
        XML_END='</locale-config>'
        for i in common/src/main/res/values*/strings.xml; do
          FOLDER="$(basename $(dirname $i))"
          CODE="${FOLDER#*-}" # remove "values-"
          CODE="${CODE/-r/-}" # replace region "-rXX" with "-XX"
          if [ "$CODE" == "values" ]; then CODE="en"; fi
          XML_LOCALES="$XML_LOCALES    <locale android:name=\"$CODE\"/>\n"
        done
        printf "$XML_START$XML_LOCALES$XML_END" > app/src/main/res/xml/locales_config.xml
        printf "$XML_START$XML_LOCALES$XML_END" > wear/src/main/res/xml/locales_config.xml

        echo "Complete"
